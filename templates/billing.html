{% extends 'base.html' %}
{% block title %}Billing{% endblock %}
{% block page_title %}Billing{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Invoices</span>
        <small class="text-muted">Actions: Pay Now (mock), PDF, Email</small>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>#</th><th>Invoice #</th><th>Client</th><th>Case</th><th>Issue</th><th>Due</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in invoices %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ inv.invoice_number }}</td>
              <td>{{ inv.client.first_name }} {{ inv.client.last_name }}</td>
              <td>{{ inv.case.title }}</td>
              <td>{{ inv.issue_date|format_date }}</td>
              <td>{{ inv.due_date|format_date }}</td>
              <td>{{ inv.total_amount|format_currency }}</td>
              <td>{{ inv.amount_paid|format_currency }}</td>
              <td>{{ inv.balance_due|format_currency }}</td>
              <td>{{ inv.status }}</td>
              <td>
                <form method="POST" action="{{ url_for('invoice_pay_mock', invoice_id=inv.id) }}" class="d-inline">
                  <input type="hidden" name="amount" value="{{ inv.balance_due or 0 }}">
                  <button type="submit" class="btn btn-sm btn-success" {% if (inv.balance_due or 0) <= 0 %}disabled{% endif %}>Pay Now</button>
                </form>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('invoice_pdf', invoice_id=inv.id) }}">PDF</a>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('invoice_email', invoice_id=inv.id) }}">Email</a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center text-muted">No invoices yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">Time Entries</div>
      <div class="card-body">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>#</th><th>Date</th><th>User</th><th>Case</th><th>Minutes</th><th>Rate</th><th>Amount</th><th>Invoice</th>
            </tr>
          </thead>
          <tbody>
            {% for te in entries %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ te.date|format_date }}</td>
              <td>{{ te.user.first_name }} {{ te.user.last_name }}</td>
              <td>{{ te.case.title }}</td>
              <td>{{ te.duration_minutes }}</td>
              <td>{{ te.hourly_rate|format_currency }}</td>
              <td>{{ te.amount|format_currency }}</td>
              <td>{% if te.invoice %}{{ te.invoice.invoice_number }}{% else %}-{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">No time entries yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">Expenses</div>
      <div class="card-body">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>#</th><th>Date</th><th>User</th><th>Case</th><th>Description</th><th>Category</th><th>Amount</th><th>Invoice</th>
            </tr>
          </thead>
          <tbody>
            {% for ex in expenses %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ ex.date|format_date }}</td>
              <td>{{ ex.user.first_name }} {{ ex.user.last_name }}</td>
              <td>{{ ex.case.title }}</td>
              <td>{{ ex.description }}</td>
              <td>{{ ex.category }}</td>
              <td>{{ ex.amount|format_currency }}</td>
              <td>{% if ex.invoice %}{{ ex.invoice.invoice_number }}{% else %}-{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">No expenses yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">Post Payment</div>
      <div class="card-body">
        <form method="POST" action="" onsubmit="this.action='/billing/invoices/'+this.invoice_id.value+'/payments'">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Invoice ID</label>
              <input type="number" class="form-control" name="invoice_id" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Method</label>
              <select class="form-select" name="payment_method">
                <option value="check">Check</option>
                <option value="online">Online</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="cash">Cash</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Reference</label>
              <input type="text" class="form-control" name="reference_number">
            </div>
          </div>
          <div class="mt-3 text-end">
            <button class="btn btn-primary" type="submit">Post Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">Trust Transfer</div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('trust_transfer') }}">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Client ID</label>
              <input type="number" class="form-control" name="client_id" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Case ID</label>
              <input type="number" class="form-control" name="case_id">
            </div>
            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" step="0.01" name="amount" required>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" name="description" placeholder="Trust transfer">
            </div>
          </div>
          <div class="mt-3 text-end">
            <button class="btn btn-secondary" type="submit">Record Transfer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
