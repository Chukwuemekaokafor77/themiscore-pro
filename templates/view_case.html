{% extends "base.html" %}

{% block title %}{{ case.title }} - LegalIntake Pro{% endblock %}

{% block page_title %}{{ case.title }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Case Details -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Case Details</span>
                <a href="{{ url_for('update_case', case_id=case.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Client</h6>
                        {% if case.client %}
                            <p>
                                <a href="{{ url_for('view_client', client_id=case.client.id) }}">
                                    {{ case.client.first_name }} {{ case.client.last_name }}
                                </a>
                            </p>
                        {% else %}
                            <span class="text-muted">No client assigned</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <span class="badge bg-{{ 'success' if case.status=='open' else 'warning' if case.status=='in_progress' else 'secondary' }}">
                            {{ case.status|replace('_',' ')|title }}
                        </span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Type</h6>
                        <p>{{ case.case_type|replace('_',' ')|title if case.case_type else 'Not specified' }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Priority</h6>
                        <span class="badge bg-{{ 'danger' if case.priority=='high' else 'warning' if case.priority=='medium' else 'info' }}">
                            {{ case.priority|title if case.priority else 'Not set' }}
                        </span>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Description</h6>
                    <p>{{ case.description or 'No description provided.' }}</p>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    Created on {{ case.created_at.strftime('%B %d, %Y') }}
                    {% if case.creator %}
                        by {{ case.creator.first_name }} {{ case.creator.last_name }}
                    {% endif %}
                </small>
            </div>
        </div>

        <!-- Actions Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Actions</span>
                <a href="#" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addActionModal">
                    <i class="bi bi-plus-lg"></i> Add Action
                </a>
            </div>
            <div class="card-body">
                {% if case.case_actions %}
                    <div class="list-group">
                        {% for ca in case.case_actions %}
                            {% set action = ca.action %}
                            <a href="{{ url_for('view_action', action_id=action.id) }}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ action.title }}</h6>
                                    <span class="badge bg-{{ 'success' if ca.status=='completed' else 'warning' if ca.status=='in_progress' else 'secondary' }}">
                                        {{ ca.status|replace('_',' ')|title }}
                                    </span>
                                </div>
                                <p class="mb-1">{{ action.description|truncate(100) if action.description else 'No description' }}</p>
                                <small>Due: {{ ca.due_date.strftime('%b %d, %Y') if ca.due_date else 'No due date' }}</small>
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No actions found. <a href="#" data-bs-toggle="modal" data-bs-target="#addActionModal">Add an action</a>.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Documents Card -->
        <div class="card mb-4">
            <div class="card-header">
                Documents <span class="badge bg-primary rounded-pill">{{ documents|length if documents else 0 }}</span>
            </div>
            <div class="card-body">
                {% if documents %}
                    <div class="list-group list-group-flush">
                        {% for doc in documents %}
                            <a href="{{ url_for('view_document', document_id=doc.id) }}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ doc.name }}</h6>
                                    <small>{{ doc.file_type|upper if doc.file_type else 'FILE' }}</small>
                                </div>
                                <small>Uploaded: {{ doc.created_at.strftime('%b %d, %Y') if doc.created_at else 'Unknown date' }}</small>
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No documents uploaded yet.</p>
                {% endif %}
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                </div>
            </div>
        </div>

        <!-- Case Notes -->
        <div class="card">
            <div class="card-header">Case Notes</div>
            <div class="card-body">
                {% if case.notes %}
                    {% for note in case.notes %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">
                                    {{ note.created_by.first_name ~ ' ' ~ note.created_by.last_name if note.created_by else 'System' }}
                                </small>
                                <small class="text-muted">
                                    {{ note.created_at.strftime('%b %d, %Y') if note.created_at else 'Unknown date' }}
                                </small>
                            </div>
                            <p>{{ note.content }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No notes yet.</p>
                {% endif %}
                <form method="POST" action="{{ url_for('add_case_note', case_id=case.id) }}">
                    <div class="mb-2">
                        <textarea name="note" class="form-control" rows="3" placeholder="Add a note..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Add Note</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Action Modal -->
<div class="modal fade" id="addActionModal" tabindex="-1" aria-labelledby="addActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addActionModalLabel">Add New Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_action') }}">
                <div class="modal-body">
                    <input type="hidden" name="case_id" value="{{ case.id }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="action_type" class="form-label">Type</label>
                                <select class="form-select" id="action_type" name="action_type">
                                    <option value="meeting">Meeting</option>
                                    <option value="document_review">Document Review</option>
                                    <option value="filing">Filing</option>
                                    <option value="research">Research</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority" name="priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Action</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('upload_document') }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" name="case_id" value="{{ case.id }}">
                    <div class="mb-3">
                        <label for="document" class="form-label">Select File</label>
                        <input class="form-control" type="file" id="document" name="document" required>
                    </div>
                    <div class="mb-3">
                        <label for="doc_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="doc_description" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
