{% extends "base.html" %}

{% block title %}Cases - LegalIntake Pro{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles for cases page */
    .case-card {
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
    }
    .case-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .case-priority-high { border-left-color: #dc3545; }
    .case-priority-medium { border-left-color: #ffc107; }
    .case-priority-low { border-left-color: #198754; }

    .case-actions .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

    .client-avatar {
        width: 40px; height: 40px;
        border-radius: 50%; background-color: #e9ecef;
        display: flex; align-items: center; justify-content: center;
        font-weight: 600; color: #495057; margin-right: 10px;
    }

    .input-group { max-width: 300px; }
    .table > :not(caption) > * > * { padding: 0.75rem 1rem; }

    .btn-group-vertical > .btn,
    .btn-group > .btn { position: relative; flex: 1 1 auto; }
</style>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-0">Case Management</h1>
        <nav aria-label="breadcrumb" class="mt-2">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Cases</li>
            </ol>
        </nav>
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCaseModal">
            <i class="bi bi-plus-lg me-1"></i> New Case
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Case Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form id="caseFilterForm" class="row g-3">
            <div class="col-md-3">
                <label for="clientFilter" class="form-label">Client</label>
                <select class="form-select select2" id="clientFilter" name="client_id">
                    <option value="">All Clients</option>
                    {% for client in clients %}
                        <option value="{{ client.id }}" {% if request.args.get('client_id') == client.id|string %}selected{% endif %}>
                            {{ client.first_name }} {{ client.last_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter" name="status">
                    <option value="">All Statuses</option>
                    {% for s, label in [('open', 'Open'), ('in_progress', 'In Progress'), ('closed', 'Closed')] %}
                        <option value="{{ s }}" {% if request.args.get('status') == s %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="priorityFilter" class="form-label">Priority</label>
                <select class="form-select" id="priorityFilter" name="priority">
                    {% for p, label, default in [('high', 'High', ''), ('medium', 'Medium', 'selected'), ('low', 'Low', '')] %}
                        <option value="{{ p }}" {% if request.args.get('priority') == p or (not request.args.get('priority') and p=='medium') %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel me-1"></i> Filter
                </button>
                <a href="{{ url_for('cases') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Cases List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-folder2-open me-2"></i>
            <span class="fw-bold">Case List</span>
            <span class="badge bg-secondary ms-2">{{ cases|length }} case{% if cases|length != 1 %}s{% endif %}</span>
        </div>
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
            <input type="text" id="caseSearch" class="form-control" placeholder="Search cases...">
        </div>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:40px;">
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="selectAllCases"></div>
                        </th>
                        <th>Case Title</th>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="casesTableBody">
                    {% for case in cases %}
                        <tr class="case-row" data-client="{{ case.client.first_name|lower }} {{ case.client.last_name|lower }}" 
                            data-status="{{ case.status }}" data-priority="{{ case.priority|default('medium') }}">
                            <td><div class="form-check"><input class="form-check-input case-checkbox" type="checkbox" value="{{ case.id }}"></div></td>
                            <td>
                                <a href="{{ url_for('view_case', case_id=case.id) }}" class="fw-bold text-dark">{{ case.title }}</a>
                                <small class="text-muted d-block">#{{ '%04d' % case.id }}</small>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="client-avatar">{{ case.client.first_name[0] }}{{ case.client.last_name[0] }}</div>
                                    <div>
                                        <div class="fw-medium">{{ case.client.first_name }} {{ case.client.last_name }}</div>
                                        <small class="text-muted">{{ case.client.email }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-soft-{{ 'primary' if case.case_type == 'personal_injury' else 'success' if case.case_type == 'family_law' else 'info' if case.case_type == 'business_law' else 'warning' if case.case_type == 'real_estate' else 'secondary' }} text-uppercase">
                                    {{ case.case_type|replace('_', ' ')|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge rounded-pill bg-{{ 'success' if case.status=='open' else 'warning' if case.status=='in_progress' else 'secondary' }}">
                                    <i class="bi {{ 'bi-check-circle' if case.status=='open' else 'bi-arrow-repeat' if case.status=='in_progress' else 'bi-x-circle' }} me-1"></i>
                                    {{ case.status|replace('_',' ')|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'danger' if case.priority=='high' else 'warning' if case.priority=='medium' else 'success' }}">
                                    <i class="bi {{ 'bi-exclamation-triangle' if case.priority=='high' else 'bi-arrow-up' if case.priority=='medium' else 'bi-arrow-down' }} me-1"></i>
                                    {{ case.priority|title }}
                                </span>
                            </td>
                            <td>
                                <span class="fw-medium">{{ case.created_at.strftime('%b %d, %Y') }}</span>
                                <small class="text-muted d-block">{{ case.created_at|time_ago }}</small>
                            </td>
                            <td class="text-end case-actions">
                                <div class="btn-group">
                                    <a href="{{ url_for('view_case', case_id=case.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Case"><i class="bi bi-eye"></i></a>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>Documents</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-event me-2"></i>Schedule</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-archive me-2"></i>Archive</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size:2rem;"></i>
                                <p class="mt-2 mb-0">No cases found.</p>
                                <a href="#" class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addCaseModal"><i class="bi bi-plus-lg me-1"></i> Add Your First Case</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Case Modal -->
<div class="modal fade" id="addCaseModal" tabindex="-1" aria-labelledby="addCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="addCaseModalLabel"><i class="bi bi-plus-circle me-2"></i>Create New Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_case') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="client_id" class="form-label">Client</label>
                            <select class="form-select" id="client_id" name="client_id" required>
                                <option value="" disabled selected>Select a client</option>
                                {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="case_type" class="form-label">Case Type</label>
                            <select class="form-select select2" id="case_type" name="case_type" required>
                                <optgroup label="Personal Injury">
                                    <option value="personal_injury">Personal Injury</option>
                                    <option value="slip_and_fall">Slip And Fall</option>
                                    <option value="car_accident">Car Accident</option>
                                    <option value="medical_malpractice">Medical Malpractice</option>
                                    <option value="wrongful_death">Wrongful Death</option>
                                    <option value="product_liability">Product Liability</option>
                                    <option value="workers_compensation">Workers Compensation</option>
                                </optgroup>
                                <optgroup label="Family Law">
                                    <option value="family_law">Family Law</option>
                                    <option value="divorce">Divorce</option>
                                    <option value="child_custody">Child Custody</option>
                                    <option value="adoption">Adoption</option>
                                    <option value="domestic_violence">Domestic Violence</option>
                                </optgroup>
                                <optgroup label="Criminal Defense">
                                    <option value="criminal_defense">Criminal Defense</option>
                                    <option value="dui">DUI</option>
                                    <option value="drug_offenses">Drug Offenses</option>
                                    <option value="white_collar">White Collar</option>
                                </optgroup>
                                <optgroup label="Employment Law">
                                    <option value="employment_law">Employment Law</option>
                                    <option value="wrongful_termination">Wrongful Termination</option>
                                    <option value="workplace_harassment">Workplace Harassment</option>
                                    <option value="wage_and_hour">Wage And Hour</option>
                                </optgroup>
                                <optgroup label="Real Estate">
                                    <option value="real_estate">Real Estate</option>
                                    <option value="landlord_tenant">Landlord Tenant</option>
                                    <option value="foreclosure">Foreclosure</option>
                                    <option value="property_disputes">Property Disputes</option>
                                    <option value="construction_law">Construction Law</option>
                                </optgroup>
                                <optgroup label="Estate & Probate">
                                    <option value="estate_planning">Estate Planning</option>
                                    <option value="probate">Probate</option>
                                    <option value="trusts">Trusts</option>
                                    <option value="guardianship">Guardianship</option>
                                </optgroup>
                                <optgroup label="Bankruptcy">
                                    <option value="bankruptcy">Bankruptcy</option>
                                    <option value="chapter_7">Chapter 7 (Liquidation)</option>
                                    <option value="chapter_11">Chapter 11 (Reorganization - Businesses)</option>
                                    <option value="chapter_13">Chapter 13 (Wage Earner Plan)</option>
                                </optgroup>
                                <optgroup label="Immigration">
                                    <option value="immigration">Immigration</option>
                                    <option value="deportation_defense">Deportation Defense</option>
                                    <option value="asylum">Asylum</option>
                                    <option value="family_based_immigration">Family Based Immigration</option>
                                </optgroup>
                                <optgroup label="Intellectual Property">
                                    <option value="intellectual_property">Intellectual Property</option>
                                    <option value="trademark">Trademark</option>
                                    <option value="patent">Patent</option>
                                    <option value="copyright">Copyright</option>
                                </optgroup>
                                <optgroup label="Regulatory & Others">
                                    <option value="tax_law">Tax Law</option>
                                    <option value="civil_rights">Civil Rights</option>
                                    <option value="education_law">Education Law</option>
                                    <option value="elder_law">Elder Law</option>
                                    <option value="environmental_law">Environmental Law</option>
                                    <option value="insurance_law">Insurance Law</option>
                                    <option value="maritime_law">Maritime Law</option>
                                    <option value="aviation_law">Aviation Law</option>
                                    <option value="securities_law">Securities Law</option>
                                    <option value="class_action">Class Action</option>
                                    <option value="mass_tort">Mass Tort</option>
                                    <option value="consumer_protection">Consumer Protection</option>
                                    <option value="privacy_data">Privacy Data</option>
                                    <option value="cybersecurity">Cybersecurity</option>
                                    <option value="municipal_law">Municipal Law</option>
                                    <option value="government_contracts">Government Contracts</option>
                                    <option value="appeals">Appeals</option>
                                    <option value="mediation">Mediation</option>
                                    <option value="arbitration">Arbitration</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="other">Other</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Case Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" required>
                                {% for s in ['open','in_progress','closed'] %}
                                    <option value="{{ s }}" {% if s=='open' %}selected{% endif %}>{{ s.replace('_',' ')|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority" required>
                                {% for p in ['low','medium','high'] %}
                                    <option value="{{ p }}" {% if p=='medium' %}selected{% endif %}>{{ p|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Case</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
